<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>MyGenda - Dashboard</title>
    <link href="style1.css" rel="stylesheet">
    <style>
        /* Styles de base pour éviter le débordement */
        #barre-laterale {
            width: 250px;
            height: 100vh;
            overflow: hidden;
            position: relative;
            background-color: #f2f2f2;
            padding: 20px;
            box-sizing: border-box;
        }

        #bienvenue {
            font-size: 18px;
            font-weight: bold;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        #logout-button {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            width: calc(100% - 40px);
            padding: 10px;
        }
    </style>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <div id="barre-laterale">
        <h2 id="bienvenue">Chargement...</h2>
        <!-- autres éléments -->
        <button id="logout-button">Déconnexion</button>
    </div>

    <script>
        // Configuration Firebase avec vos clés
        const firebaseConfig = {
            apiKey: "AIzaSyBVy-VDJ70EwE1xLcQbjECNPbxy1R8p3_g",
            authDomain: "mygenda-53f53.firebaseapp.com",
            projectId: "mygenda-53f53",
            storageBucket: "mygenda-53f53.firebasestorage.app",
            messagingSenderId: "485805978040",
            appId: "1:485805978040:web:bf77d1457822af6d59df4d",
            measurementId: "G-7D6WGYN0QL"
        };

        // Initialiser Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Fonction pour rediriger vers la page de connexion
        function redirectToLogin() {
            window.location.href = "index.html";
        }

        // Vérifier si l'utilisateur est connecté
        auth.onAuthStateChanged(user => {
            if (user) {
                // Essayer d'abord de récupérer les données depuis Firestore
                db.collection('users').doc(user.uid).get()
                    .then(doc => {
                        if (doc.exists) {
                            const userData = doc.data();
                            document.getElementById("bienvenue").innerText = `Bienvenue ${userData.prenom} ${userData.nom}`;
                            
                            // Stocker les données en session pour d'autres pages
                            sessionStorage.setItem("userPrenom", userData.prenom);
                            sessionStorage.setItem("userNom", userData.nom);
                            sessionStorage.setItem("userEmail", userData.email);
                        } else {
                            // Fallback si les données ne sont pas trouvées dans Firestore
                            const prenom = sessionStorage.getItem("userPrenom");
                            const nom = sessionStorage.getItem("userNom");
                            
                            if (prenom && nom) {
                                document.getElementById("bienvenue").innerText = `Bienvenue ${prenom} ${nom}`;
                            } else {
                                document.getElementById("bienvenue").innerText = `Bienvenue ${user.email}`;
                            }
                        }
                    })
                    .catch(error => {
                        console.error("Erreur lors de la récupération des données:", error);
                        
                        // Fallback vers sessionStorage
                        const prenom = sessionStorage.getItem("userPrenom");
                        const nom = sessionStorage.getItem("userNom");
                        
                        if (prenom && nom) {
                            document.getElementById("bienvenue").innerText = `Bienvenue ${prenom} ${nom}`;
                        } else {
                            document.getElementById("bienvenue").innerText = `Bienvenue ${user.email}`;
                        }
                    });
            } else {
                // L'utilisateur n'est pas connecté
                alert("Vous n'êtes pas connecté. Redirection vers la page de connexion.");
                redirectToLogin();
            }
        });

        // Déconnexion
        document.getElementById("logout-button").addEventListener("click", async () => {
            try {
                await auth.signOut();
                
                // Nettoyer le stockage local
                sessionStorage.removeItem("userPrenom");
                sessionStorage.removeItem("userNom");
                sessionStorage.removeItem("userEmail");
                
                console.log("Déconnexion réussie");
                redirectToLogin();
            } catch (error) {
                console.error("Erreur de déconnexion:", error);
                
                // En cas d'erreur, on vide quand même le stockage local
                sessionStorage.removeItem("userPrenom");
                sessionStorage.removeItem("userNom");
                sessionStorage.removeItem("userEmail");
                
                alert("Erreur lors de la déconnexion, mais vous avez été déconnecté localement");
                redirectToLogin();
            }
        });
    </script>
</body>
</html>
