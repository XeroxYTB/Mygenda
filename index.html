<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MyGenda - Connexion</title>
  <link rel="stylesheet" href="styless.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Bagel+Fat+One&display=swap" rel="stylesheet" />
  
  <!-- Firebase SDK (version modifiée) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
</head>
<body>
  <div id="container">
    <h1 id="form-title">Connexion</h1>
    <h3 id="mygenda">MyGenda</h3>

    <!-- Formulaire de connexion -->
    <form id="login-form">
      <input type="email" id="login-email" placeholder="Email" required />
      <input type="password" id="login-password" placeholder="Mot de passe" required />
      <p class="error" id="login-error"></p>
      <button type="submit" id="login-button">Se connecter</button>
      <p class="toggle-form">Pas encore de compte ? <a href="#" id="show-register">Inscrivez-vous</a></p>
    </form>

    <!-- Formulaire d'inscription -->
    <form id="register-form" class="hidden">
      <input type="text" id="register-nom" placeholder="Nom" required />
      <input type="text" id="register-prenom" placeholder="Prénom" required />
      <input type="email" id="register-email" placeholder="Email" required />
      <input type="password" id="register-password" placeholder="Mot de passe" required />
      <p class="error" id="register-error"></p>
      <button type="submit" id="register-button">S'inscrire</button>
      <p class="toggle-form">Déjà un compte ? <a href="#" id="show-login">Connectez-vous</a></p>
    </form>
  </div>

  <script>
    // Attendre que tout le DOM soit chargé
    document.addEventListener('DOMContentLoaded', function() {
      // Configuration Firebase avec vos clés
      const firebaseConfig = {
        apiKey: "AIzaSyBVy-VDJ70EwE1xLcQbjECNPbxy1R8p3_g",
        authDomain: "mygenda-53f53.firebaseapp.com",
        projectId: "mygenda-53f53",
        storageBucket: "mygenda-53f53.firebasestorage.app",
        messagingSenderId: "485805978040",
        appId: "1:485805978040:web:bf77d1457822af6d59df4d",
        measurementId: "G-7D6WGYN0QL"
      };

      // Initialiser Firebase
      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.firestore();
      
      console.log("Firebase initialisé");

      // Vérifier si l'utilisateur est déjà connecté
      auth.onAuthStateChanged(user => {
        console.log("État de l'authentification vérifié", user ? "Utilisateur connecté" : "Utilisateur non connecté");
        if (user) {
          // Récupérer les données de l'utilisateur depuis Firestore
          db.collection('users').doc(user.uid).get()
            .then(doc => {
              if (doc.exists) {
                const userData = doc.data();
                // Stocker les données en session pour faciliter l'accès
                sessionStorage.setItem("userPrenom", userData.prenom);
                sessionStorage.setItem("userNom", userData.nom);
                sessionStorage.setItem("userEmail", userData.email);
                
                console.log("Redirection vers la page principale");
                // Rediriger vers la page principale
                window.location.href = "main1.html";
              } else {
                console.log("Document utilisateur non trouvé dans Firestore");
                sessionStorage.setItem("userEmail", user.email);
                window.location.href = "main1.html";
              }
            })
            .catch(error => {
              console.error("Erreur lors de la récupération des données utilisateur:", error);
              window.location.href = "https://xeroxytb.github.io/Mygenda/home";
            });
        }
      });

      // Changer entre les formulaires
      document.getElementById("show-register").addEventListener("click", (e) => {
        e.preventDefault();
        document.getElementById("login-form").classList.add("hidden");
        document.getElementById("register-form").classList.remove("hidden");
        document.getElementById("form-title").innerText = "Inscription";
      });

      document.getElementById("show-login").addEventListener("click", (e) => {
        e.preventDefault();
        document.getElementById("register-form").classList.add("hidden");
        document.getElementById("login-form").classList.remove("hidden");
        document.getElementById("form-title").innerText = "Connexion";
      });

      // Inscription
      document.getElementById("register-form").addEventListener("submit", function(e) {
        e.preventDefault();
        console.log("Formulaire d'inscription soumis");
        document.getElementById("register-error").innerText = "";
        
        const nom = document.getElementById("register-nom").value;
        const prenom = document.getElementById("register-prenom").value;
        const email = document.getElementById("register-email").value;
        const password = document.getElementById("register-password").value;

        // Désactiver le bouton pendant l'inscription
        document.getElementById("register-button").disabled = true;

        auth.createUserWithEmailAndPassword(email, password)
          .then(userCredential => {
            const user = userCredential.user;
            console.log("Compte créé avec succès:", user.uid);
            
            // Enregistrer les informations supplémentaires dans Firestore
            return db.collection('users').doc(user.uid).set({
              nom: nom,
              prenom: prenom,
              email: email,
              dateInscription: firebase.firestore.FieldValue.serverTimestamp()
            });
          })
          .then(() => {
            console.log("Données utilisateur enregistrées avec succès");
            alert("Inscription réussie !");
            document.getElementById("show-login").click();
          })
          .catch(error => {
            console.error("Erreur d'inscription:", error);
            let errorMessage = "Erreur lors de l'inscription.";
            
            if (error.code === 'auth/email-already-in-use') {
              errorMessage = "Cette adresse email est déjà utilisée.";
            } else if (error.code === 'auth/weak-password') {
              errorMessage = "Le mot de passe doit contenir au moins 6 caractères.";
            } else if (error.code === 'auth/invalid-email') {
              errorMessage = "L'adresse email n'est pas valide.";
            }
            
            document.getElementById("register-error").innerText = errorMessage;
          })
          .finally(() => {
            // Réactiver le bouton
            document.getElementById("register-button").disabled = false;
          });
      });

      // Connexion
      document.getElementById("login-form").addEventListener("submit", function(e) {
        e.preventDefault();
        console.log("Formulaire de connexion soumis");
        document.getElementById("login-error").innerText = "";
        
        const email = document.getElementById("login-email").value;
        const password = document.getElementById("login-password").value;
        
        // Désactiver le bouton pendant la connexion
        document.getElementById("login-button").disabled = true;

        auth.signInWithEmailAndPassword(email, password)
          .then(userCredential => {
            const user = userCredential.user;
            console.log("Connexion réussie:", user.uid);
            sessionStorage.setItem("userEmail", email);
            
            // La redirection est gérée par onAuthStateChanged
          })
          .catch(error => {
            console.error("Erreur de connexion:", error);
            let errorMessage = "Identifiants incorrects.";
            
            if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
              errorMessage = "Email ou mot de passe incorrect.";
            } else if (error.code === 'auth/too-many-requests') {
              errorMessage = "Trop de tentatives échouées. Veuillez réessayer plus tard.";
            }
            
            document.getElementById("login-error").innerText = errorMessage;
          })
          .finally(() => {
            // Réactiver le bouton
            document.getElementById("login-button").disabled = false;
          });
      });
    });
  </script>
</body>
</html>

